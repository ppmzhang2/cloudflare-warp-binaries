name: Auto-Publish Warp Trixie Binaries

on:
  schedule:
    - cron: "0 0 * * 0"  # Every Sunday at 00:00 UTC
  push:
    branches: [ master ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-and-release:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.check.outputs.version }}
      update_needed: ${{ steps.check.outputs.update_needed }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for new version (Trixie)
        id: check
        run: |
          CODENAME="trixie"
          ARCH="amd64"
          PKG="cloudflare-warp"
          PKG_URL="https://pkg.cloudflareclient.com/dists/${CODENAME}/main/binary-${ARCH}/Packages.gz"

          # Fetch remote version
          REMOTE_VER=$(curl -fsSL "$PKG_URL" | gzip -dc | awk -v pkg="$PKG" '$1=="Package:" {p=($2==pkg)} p && $1=="Version:" {print $2; exit}')
          
          # Read local version
          LOCAL_VER=$(cat warp-debian.version 2>/dev/null || echo "none")

          echo "Remote version: $REMOTE_VER"
          echo "Local version:  $LOCAL_VER"

          if [ "$REMOTE_VER" != "$LOCAL_VER" ] && [ -n "$REMOTE_VER" ]; then
            echo "update_needed=true" >> $GITHUB_OUTPUT
            echo "version=$REMOTE_VER" >> $GITHUB_OUTPUT
          else
            echo "update_needed=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Tools
        if: steps.check.outputs.update_needed == 'true'
        run: sudo apt-get update && sudo apt-get install -y binutils xz-utils zstd curl

      # We process both architectures in one job to consolidate the Release assets
      - name: Extract Binaries (amd64 & arm64)
        if: steps.check.outputs.update_needed == 'true'
        run: |
          VERSION="${{ steps.check.outputs.version }}"
          mkdir -p dist extracted
          
          for ARCH in amd64 arm64; do
            URL="https://pkg.cloudflareclient.com/pool/trixie/main/c/cloudflare-warp/cloudflare-warp_${VERSION}_${ARCH}.deb"
            echo "Processing $ARCH from $URL"
            
            curl -fsSL "$URL" -o "dist/warp_${ARCH}.deb"
            
            mkdir -p "work-$ARCH" "rootfs-$ARCH"
            pushd "work-$ARCH" > /dev/null
            ar x "../dist/warp_${ARCH}.deb"
            
            # Identify and extract the data payload
            if [ -f data.tar.zst ]; then 
              tar --zstd -xf data.tar.zst -C ../rootfs-$ARCH
            elif [ -f data.tar.xz ]; then 
              tar -xJf data.tar.xz -C ../rootfs-$ARCH
            else 
              tar -xzf data.tar.gz -C ../rootfs-$ARCH
            fi
            popd > /dev/null
      
            # DYNAMIC SEARCH: Find the binaries wherever they are in the rootfs
            for BIN in warp-svc warp-cli; do
              # find searches recursively; head -n 1 handles duplicates if any
              FOUND_PATH=$(find "rootfs-$ARCH" -type f -name "$BIN" | head -n 1)
              
              if [ -n "$FOUND_PATH" ]; then
                echo "Found $BIN at: $FOUND_PATH"
                mv "$FOUND_PATH" "extracted/${BIN}-${ARCH}"
                chmod +x "extracted/${BIN}-${ARCH}"
              else
                echo "::error::Could not find $BIN in $ARCH package!"
                echo "Directory structure for debugging:"
                ls -R "rootfs-$ARCH"
                exit 1
              fi
            done
          done

      - name: Update version file in repo
        if: steps.check.outputs.update_needed == 'true'
        run: |
          echo "${{ steps.check.outputs.version }}" > warp-debian.version
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add warp-debian.version
          git commit -m "chore: update warp to ${{ steps.check.outputs.version }}"
          git push

      - name: Create GitHub Release
        if: steps.check.outputs.update_needed == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.check.outputs.version }}
          name: "Warp Trixie v${{ steps.check.outputs.version }}"
          body: "Automated extraction from Debian Trixie repository."
          files: extracted/*
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
